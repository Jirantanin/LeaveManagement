<template>
  <div class="p-8 max-w-3xl">
    <div class="mb-8">
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
        <NuxtLink to="/admin/employees" class="hover:text-blue-600">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</NuxtLink>
        <span>/</span>
        <span class="text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h1>
      <p class="text-gray-500 text-sm mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
    </div>

    <form @submit.prevent="submit" class="space-y-6">
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
      <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="font-semibold text-gray-900 mb-5 flex items-center gap-2">
          <span class="text-lg">üîë</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <input v-model="form.employeeId" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô EMP001" class="input" />
            <p class="hint">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™</p>
          </div>
          <div>
            <label class="label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• <span class="text-red-500">*</span></label>
            <input v-model="form.name" type="text" required placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="input" />
          </div>
          <div>
            <label class="label">‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span class="text-red-500">*</span></label>
            <input v-model="form.email" type="email" required placeholder="email@company.com" class="input" />
          </div>
          <div>
            <label class="label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô <span class="text-red-500">*</span></label>
            <input v-model="form.password" type="password" required placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" minlength="6" class="input" />
          </div>
        </div>
      </section>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
      <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="font-semibold text-gray-900 mb-5 flex items-center gap-2">
          <span class="text-lg">üè¢</span> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="label">‡πÅ‡∏ú‡∏ô‡∏Å <span class="text-red-500">*</span></label>
            <select v-model="form.department" required class="input" @change="form.position = ''">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
              <option v-for="d in departments" :key="d" :value="d">{{ d }}</option>
            </select>
          </div>
          <div>
            <label class="label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á <span class="text-red-500">*</span></label>
            <select v-if="positionOptions.length" v-model="form.position" required class="input">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
              <option v-for="p in positionOptions" :key="p" :value="p">{{ p }}</option>
            </select>
            <input v-else v-model="form.position" type="text" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" class="input" />
          </div>
          <div>
            <label class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</label>
            <input v-model="form.hireDate" type="date" class="input" />
          </div>
        </div>
      </section>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
      <section class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="font-semibold text-gray-900 mb-5 flex items-center gap-2">
          <span class="text-lg">üë§</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="label">‡πÄ‡∏û‡∏®</label>
            <select v-model="form.gender" class="input">
              <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
              <option v-for="g in genders" :key="g.value" :value="g.value">{{ g.label }}</option>
            </select>
          </div>
          <div>
            <label class="label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
            <input v-model="form.birthDate" type="date" class="input" />
          </div>
          <div>
            <label class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input v-model="form.phone" type="tel" placeholder="08X-XXX-XXXX" class="input" />
          </div>
          <div class="sm:col-span-2">
            <label class="label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
            <textarea v-model="form.address" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="input resize-none" />
          </div>
        </div>
      </section>

      <!-- Error / Actions -->
      <p v-if="error" class="text-red-600 text-sm bg-red-50 border border-red-200 rounded-lg px-4 py-3">{{ error }}</p>

      <div class="flex gap-3">
        <button
          type="submit"
          :disabled="loading"
          class="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-semibold px-6 py-2.5 rounded-lg transition-colors text-sm"
        >
          {{ loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' }}
        </button>
        <NuxtLink
          to="/admin/employees"
          class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"
        >
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </NuxtLink>
      </div>
    </form>
  </div>
</template>

<script setup lang="ts">
definePageMeta({ layout: 'admin' })

const { apiFetch, loadFromStorage, user } = useAuth()
const { departments, genders, POSITIONS } = await import('~/composables/useEmployeeOptions')

const form = reactive({
  employeeId: '', name: '', email: '', password: '',
  department: '', position: '',
  gender: '', phone: '', birthDate: '', hireDate: '', address: ''
})

const positionOptions = computed(() => POSITIONS[form.department] || [])

const loading = ref(false)
const error = ref('')

async function submit() {
  loading.value = true
  error.value = ''
  try {
    const emp = await apiFetch('/api/admin/employees', {
      method: 'POST',
      body: form
    })
    navigateTo(`/admin/employees/${emp.id}`)
  } catch (e: any) {
    error.value = e?.data?.statusMessage || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'
  } finally {
    loading.value = false
  }
}

onMounted(() => {
  loadFromStorage()
  if (!user.value || user.value.role !== 'admin') navigateTo('/login')
})
</script>

<style scoped>
.label { @apply block text-sm font-medium text-gray-700 mb-1.5; }
.input { @apply w-full px-3.5 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm; }
.hint  { @apply text-xs text-gray-400 mt-1; }
</style>
